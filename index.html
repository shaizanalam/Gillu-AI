<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>गिल्लू - Hindi/English Voice Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans Devanagari', sans-serif;
      background: #000000;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }

    #wallpaper-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }

    .container_chat_bot {
      display: flex;
      flex-direction: column;
      max-width: 500px;
      width: 100%;
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      color: white;
    }

    .header h1 {
     font-size: 24px;
     margin-bottom: 5px;
     background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
     -webkit-background-clip: text;
     background-clip: text;
     -webkit-text-fill-color: transparent;
     color: transparent;
   }

    .header p {
      font-size: 14px;
      opacity: 0.7;
    }

    .chat-history {
      background: rgba(30, 30, 30, 0.7);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
      max-height: 300px;
      overflow-y: auto;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .chat-history .message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 15px;
      max-width: 80%;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
    }

    .chat-history .user-message {
      background: rgba(37, 117, 252, 0.2);
      margin-left: auto;
      border-bottom-right-radius: 5px;
      border: 1px solid rgba(37, 117, 252, 0.3);
    }

    .chat-history .bot-message {
      background: rgba(106, 17, 203, 0.2);
      margin-right: auto;
      border-bottom-left-radius: 5px;
      border: 1px solid rgba(106, 17, 203, 0.3);
    }

    .chat-history .message-time {
      font-size: 10px;
      opacity: 0.6;
      margin-top: 5px;
      text-align: right;
    }

    .container-chat-options {
      position: relative;
      display: flex;
      background: linear-gradient(
        to bottom right,
        #2a2a2a,
        #1a1a1a,
        #1a1a1a,
        #1a1a1a,
        #1a1a1a
      );
      border-radius: 16px;
      padding: 1.5px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .container-chat-options::after {
      position: absolute;
      content: "";
      top: -10px;
      left: -10px;
      background: radial-gradient(
        ellipse at center,
        #ffffff,
        rgba(255, 255, 255, 0.3),
        rgba(255, 255, 255, 0.1),
        rgba(0, 0, 0, 0),
        rgba(0, 0, 0, 0),
        rgba(0, 0, 0, 0),
        rgba(0, 0, 0, 0)
      );
      width: 30px;
      height: 30px;
      filter: blur(1px);
    }

    .chat {
      display: flex;
      flex-direction: column;
      background-color: rgba(10, 10, 10, 0.8);
      border-radius: 15px;
      width: 100%;
      overflow: hidden;
    }

    .chat-bot {
      position: relative;
      display: flex;
    }

    .chat-bot textarea {
      background-color: transparent;
      border-radius: 16px;
      border: none;
      width: 100%;
      height: 60px;
      color: #ffffff;
      font-family: sans-serif;
      font-size: 14px;
      font-weight: 400;
      padding: 15px;
      resize: none;
      outline: none;
    }

    .chat-bot textarea::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .chat-bot textarea::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-bot textarea::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 5px;
    }

    .chat-bot textarea::-webkit-scrollbar-thumb:hover {
      background: #666;
      cursor: pointer;
    }

    .chat-bot textarea::placeholder {
      color: #888;
      transition: all 0.3s ease;
    }

    .chat-bot textarea:focus::placeholder {
      color: #555;
    }

    .options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
    }

    .btn-mic {
      display: flex;
      padding: 2px;
      background-image: linear-gradient(to top, #1a1a1a, #333, #1a1a1a);
      border-radius: 10px;
      box-shadow: inset 0 6px 2px -4px rgba(255, 255, 255, 0.1);
      cursor: pointer;
      border: none;
      outline: none;
      transition: all 0.15s ease;
    }

    .btn-mic i {
      width: 30px;
      height: 30px;
      padding: 6px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      backdrop-filter: blur(3px);
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-mic svg {
      transition: all 0.3s ease;
    }

    .btn-mic:hover svg {
      color: #ffffff;
      filter: drop-shadow(0 0 5px #ffffff);
    }

    .btn-mic:focus svg {
      color: #ffffff;
      filter: drop-shadow(0 0 5px #ffffff);
    }

    .btn-mic:active {
      transform: scale(0.92);
    }

    .btn-submit {
      display: flex;
      padding: 2px;
      background-image: linear-gradient(to top, #1a1a1a, #333, #1a1a1a);
      border-radius: 10px;
      box-shadow: inset 0 6px 2px -4px rgba(255, 255, 255, 0.1);
      cursor: pointer;
      border: none;
      outline: none;
      transition: all 0.15s ease;
    }

    .btn-submit i {
      width: 30px;
      height: 30px;
      padding: 6px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      backdrop-filter: blur(3px);
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-submit svg {
      transition: all 0.3s ease;
    }

    .btn-submit:hover svg {
      color: #ffffff;
      filter: drop-shadow(0 0 5px #ffffff);
    }

    .btn-submit:focus svg {
      color: #ffffff;
      filter: drop-shadow(0 0 5px #ffffff);
      transform: scale(1.2) rotate(45deg) translateX(-2px) translateY(1px);
    }

    .btn-submit:active {
      transform: scale(0.92);
    }

    .tags {
      padding: 14px 0;
      display: flex;
      color: #ffffff;
      font-size: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tags span {
      padding: 6px 12px;
      background-color: #111;
      border: 1.5px solid #333;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
    }

    .tags span:hover {
      background-color: #222;
      border-color: #555;
      transform: translateY(-2px);
    }

    .tags span:active {
      transform: translateY(0);
    }

    .footer {
      text-align: center;
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    /* Animation for new messages */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Floating Characters Background */
    .floating-char {
      position: absolute;
      font-weight: bold;
      opacity: 0.7;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      user-select: none;
      transition: all 0.5s ease;
      font-family: 'Noto Sans Devanagari', sans-serif;
    }

    /* Language Toggle Styles */
    .language-toggle-container {
      display: flex;
      justify-content: center;
      margin-bottom: 15px;
    }

    .toggle-button-cover {
      position: relative;
      width: 74px;
      height: 36px;
      box-sizing: border-box;
    }

    .button-cover {
      height: 100px;
      margin: 20px;
      background-color: #fff;
      box-shadow: 0 10px 20px -8px #c5d6d6;
      border-radius: 4px;
    }

    .button-cover:before {
      counter-increment: button-counter;
      content: counter(button-counter);
      position: absolute;
      right: 0;
      bottom: 0;
      color: #d7e3e3;
      font-size: 12px;
      line-height: 1;
      padding: 5px;
    }

    .button-cover,
    .knobs,
    .layer {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }

    .button {
      position: relative;
      width: 74px;
      height: 36px;
      overflow: hidden;
    }

    .button.r,
    .button.r .layer {
      border-radius: 100px;
    }

    .checkbox {
      position: relative;
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
      opacity: 0;
      cursor: pointer;
      z-index: 3;
    }

    .knobs {
      z-index: 2;
    }

    .layer {
      width: 100%;
      background-color: #ebf7fc;
      transition: 0.3s ease all;
      z-index: 1;
    }

    #button-3 .knobs:before {
      content: "हिन्दी";
      position: absolute;
      top: 4px;
      left: 4px;
      width: 20px;
      height: 10px;
      color: #fff;
      font-size: 10px;
      font-weight: bold;
      text-align: center;
      line-height: 1;
      padding: 9px 4px;
      background: linear-gradient(90deg, #ff6b6b 0%, #ff4757 100%);
      border-radius: 50%;
      transition: 0.3s ease all, left 0.3s cubic-bezier(0.18, 0.89, 0.35, 1.15);
    }

    #button-3 .checkbox:active + .knobs:before {
      width: 46px;
      border-radius: 100px;
    }

    #button-3 .checkbox:checked:active + .knobs:before {
      margin-left: -26px;
    }

    #button-3 .checkbox:checked + .knobs:before {
      content: "Eng";
      left: 42px;
      background: linear-gradient(90deg, #2575fc 0%, #4b6cb7 100%);
    }

    #button-3 .checkbox:checked ~ .layer {
      background-color: #e3f2fd;
    }

    /* Responsive design */
    @media (max-width: 480px) {
      .container_chat_bot {
        max-width: 100%;
      }
      
      .tags {
        justify-content: center;
      }
      
      .toggle-button-cover {
        transform: scale(0.9);
      }
    }

    .loading {
      opacity: 0.7;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="wallpaper-container"></div>
  
  <div class="container_chat_bot">
    <div class="header">
      <!-- Language Toggle Switch -->
      <div class="language-toggle-container">
        <div class="toggle-button-cover">
          <div id="button-3" class="button r">
            <input class="checkbox" type="checkbox" id="lang-toggle">
            <div class="knobs"></div>
            <div class="layer"></div>
          </div>
        </div>
      </div>
      
      <h1 id="app-title">🪷 गिल्लू - आपका हिंदी वॉइस असिस्टेंट</h1>
      <p id="app-subtitle">बोलिए या लिखिए, मैं आपकी सहायता के लिए यहाँ हूँ</p>
    </div>
    
    <div class="chat-history" id="chat-box">
      <div class="message bot-message">
        <span id="welcome-message">नमस्ते! मैं गिल्लू हूं, आपका हिंदी सहायक। मैं आपकी क्या सहायता कर सकता हूं?</span>
        <div class="message-time" id="welcome-time">अभी</div>
      </div>
    </div>
    
    <div class="container-chat-options">
      <div class="chat">
        <div class="chat-bot">
          <textarea
            id="user-input"
            name="user-input"
            placeholder="बोलिए या लिखिए... ✦˚"
          ></textarea>
        </div>
        <div class="options">
          <button class="btn-mic" onclick="startVoice()">
            <i>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                <path fill="currentColor" d="M12 15c1.66 0 2.99-1.34 2.99-3L15 6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3m5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.42 2.72 6.23 6 6.72V22h2v-3.28c3.28-.48 6-3.3 6-6.72z"/>
              </svg>
            </i>
          </button>
          <button class="btn-submit" onclick="sendMessage()">
            <i>
              <svg viewBox="0 0 512 512" width="20" height="20">
                <path
                  fill="currentColor"
                  d="M473 39.05a24 24 0 0 0-25.5-5.46L47.47 185h-.08a24 24 0 0 0 1 45.16l.41.13l137.3 58.63a16 16 0 0 0 15.54-3.59L422 80a7.07 7.07 0 0 1 10 10L226.66 310.26a16 16 0 0 0-3.59 15.54l58.65 137.38c.06.2.12.38.19.57c3.2 9.27 11.3 15.81 21.09 16.25h1a24.63 24.63 0 0 0 23-15.46L478.39 64.62A24 24 0 0 0 473 39.05"
                ></path>
              </svg>
            </i>
          </button>
        </div>
      </div>
    </div>
    
    <div class="tags" id="tags-container">
      <span>प्रसिद्ध हिंदी लेखकों के नाम बताइए</span>
      <span>मुझे हिंदी अल्फाबेट के बारे में बताओ</span>
      <span>आपका क्या नाम है</span>
      <span>मुझे हिंदी भाषा के बारे में रोचक तथ्य बताइए</span>
    </div>
    
    <div class="footer">
      <div>अक्षर: <span id="char-count">50</span></div>
      <div>गति: <span id="speed-value">1.0</span>x</div>
    </div>
  </div>

  <script>
    // Configuration
    const API_KEY = "AIzaSyCCHFaulavrRNFEOZ2Xp-SgH_Ii7YUyqKM";
    
    // System instructions for Gemini
    const SYSTEM_INSTRUCTIONS = {
      'hi': "आप एक मददगार और विनम्र हिंदी सहायक हैं, जिसका नाम 'गिल्लू' है। आपकी प्राथमिक भाषा हिंदी (देवनागरी स्क्रिप्ट) है। उपयोगकर्ता के सभी सवालों का जवाब हिंदी में दें। और ** का उपयोग करके टेक्स्ट को हाइलाइट न करें। आप एक हिंदी वॉइस असिस्टेंट हैं जिसका नाम 'गिल्लू' है। आपके जवाब टेक्स्ट-टू-स्पीच इंजन द्वारा बोले जाएंगे, इसलिए: वाक्य छोटे और बातचीत वाले रखें। सरल, प्राकृतिक हिंदी का उपयोग करें जो बोलने में अच्छी लगे। विशेष वर्ण, प्रतीक, या लंबी सूचियों से बचें। विनम्र और दोस्ताना तरीके से बात करें। कोड, HTML टैग, या अनावश्यक विराम चिह्न शामिल न करें। कभी भी 'एआई मॉडल' या 'एक सहायक के रूप में' जैसी बातें न कहें।",
      'en': "You are a helpful and polite English assistant named 'Gillu'. Your primary language is English. Answer all user questions in English. And don't use ** to highlight text. You are an English voice assistant named 'Gillu'. Your responses will be spoken aloud by a Text-to-Speech engine, so: Keep sentences short and conversational. Use natural, simple English that sounds good when spoken. Avoid special characters, symbols, or long lists. Speak politely and warmly, as a friendly helper. Do not include code, HTML tags, or unnecessary punctuation. Never say things like 'AI model' or 'as an assistant'."
    };

    // Language configuration
    const translations = {
      hi: {
        title: "🪷 गिल्लू - आपका हिंदी वॉइस असिस्टेंट",
        subtitle: "बोलिए या लिखिए, मैं आपकी सहायता के लिए यहाँ हूँ",
        welcome: "नमस्ते! मैं गिल्लू हूं, आपका हिंदी सहायक। मैं आपकी क्या सहायता कर सकता हूं?",
        placeholder: "बोलिए या लिखिए... ✦˚",
        userPrefix: "आप",
        botPrefix: "गिल्लू",
        tags: [
          "प्रसिद्ध हिंदी लेखकों के नाम बताइए",
          "मुझे हिंदी अल्फाबेट के बारे में बताओ",
          "आपका क्या नाम है",
          "मुझे हिंदी भाषा के बारे में रोचक तथ्य बताइए"
        ],
        charText: "अक्षर",
        speedText: "गति",
        nowText: "अभी",
        thinking: "सोच रहा हूँ...",
        error: "क्षमा करें, कुछ त्रुटि हुई। कृपया पुनः प्रयास करें।"
      },
      en: {
        title: "🪷 Gillu - Your English Voice Assistant",
        subtitle: "Speak or type, I'm here to help you",
        welcome: "Hello! I'm Gillu, your English assistant. How can I help you today?",
        placeholder: "Speak or type... ✦˚",
        userPrefix: "You",
        botPrefix: "Gillu",
        tags: [
          "Tell me about famous English authors",
          "Explain English grammar rules",
          "What is your name?",
          "Share interesting facts about English language"
        ],
        charText: "Chars",
        speedText: "Speed",
        nowText: "Now",
        thinking: "Thinking...",
        error: "Sorry, something went wrong. Please try again."
      }
    };

    // Character sets for different languages
    const characterSets = {
      hi: [
        'अ', 'आ', 'इ', 'ई', 'उ', 'ऊ', 'ऋ', 'ए', 'ऐ', 'ओ', 'औ',
        'क', 'ख', 'ग', 'घ', 'ङ', 'च', 'छ', 'ज', 'झ', 'ञ',
        'ट', 'ठ', 'ड', 'ढ', 'ण', 'त', 'थ', 'द', 'ध', 'न',
        'प', 'फ', 'ब', 'भ', 'म', 'य', 'र', 'ल', 'व', 'श',
        'ष', 'स', 'ह', 'क्ष', 'त्र', 'ज्ञ'
      ],
      en: [
        'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M',
        'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
        'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm',
        'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'
      ]
    };

    let currentLang = 'hi';
    let isProcessing = false;
    let chatHistory = {
      'hi': [],
      'en': []
    };

    const container = document.getElementById('wallpaper-container');
    let chars = [];
    let speedFactor = 0.35;

    // Color themes that complement the interface
    const colorThemes = [
      ['#6a11cb', '#2575fc', '#8a2be2', '#4b6cb7'],  // Blue/Purple theme
      ['#00b4db', '#0083b0', '#00c9ff', '#0099cc'],  // Blue theme
      ['#667eea', '#764ba2', '#8e44ad', '#9b59b6']   // Purple theme
    ];
    let colorTheme = 0;

    // Language switching function
    function switchLanguage() {
      currentLang = currentLang === 'hi' ? 'en' : 'hi';
      updateInterfaceLanguage();
      updateBackgroundCharacters();
    }

    function updateInterfaceLanguage() {
      const lang = translations[currentLang];
      
      // Update text elements
      document.getElementById('app-title').textContent = lang.title;
      document.getElementById('app-subtitle').textContent = lang.subtitle;
      document.getElementById('user-input').placeholder = lang.placeholder;
      document.getElementById('welcome-message').textContent = lang.welcome;
      
      // Update footer
      const footerDivs = document.querySelectorAll('.footer div');
      footerDivs[0].innerHTML = `${lang.charText}: <span id="char-count">${chars.length}</span>`;
      footerDivs[1].innerHTML = `${lang.speedText}: <span id="speed-value">${speedFactor.toFixed(1)}</span>x`;
      
      // Update tags
      const tagsContainer = document.getElementById('tags-container');
      tagsContainer.innerHTML = '';
      lang.tags.forEach(tagText => {
        const span = document.createElement('span');
        span.textContent = tagText;
        span.addEventListener('click', () => {
          document.getElementById('user-input').value = tagText;
          sendMessage();
        });
        tagsContainer.appendChild(span);
      });
    }

    // Update background characters based on language
    function updateBackgroundCharacters() {
      // Remove all existing characters
      chars.forEach(char => {
        if (char.element && char.element.parentNode) {
          char.element.parentNode.removeChild(char.element);
        }
      });
      chars = [];
      
      // Create new characters with the current language's character set
      createCharacters(50);
    }

    // Create initial characters
    function createCharacters(count) {
      for (let i = 0; i < count; i++) {
        createCharacter();
      }
    }

    function createCharacter() {
      const charElement = document.createElement('div');
      charElement.className = 'floating-char';
      
      const currentCharSet = characterSets[currentLang];
      const randomChar = currentCharSet[Math.floor(Math.random() * currentCharSet.length)];
      charElement.textContent = randomChar;
      
      const posX = Math.random() * 100;
      const posY = Math.random() * 100;
      charElement.style.left = `${posX}%`;
      charElement.style.top = `${posY}%`;
      
      // Adjust size based on language
      const baseSize = currentLang === 'hi' ? 2 : 1.8;
      const size = Math.random() * 1 + baseSize;
      charElement.style.fontSize = `${size}rem`;
      
      // Adjust font weight for better visibility
      charElement.style.fontWeight = currentLang === 'hi' ? 'bold' : 'normal';
      
      const speedX = (Math.random() - 0.5) * 2;
      const speedY = (Math.random() - 0.5) * 2;
      
      applyColor(charElement);
      
      container.appendChild(charElement);
      
      chars.push({
        element: charElement,
        x: posX,
        y: posY,
        speedX: speedX,
        speedY: speedY,
        size: size
      });
      
      updateCharCount();
    }

    function applyColor(charElement) {
      const colors = colorThemes[colorTheme];
      const color = colors[Math.floor(Math.random() * colors.length)];
      charElement.style.color = color;
      charElement.style.textShadow = `0 0 10px ${color}80`;
    }

    function updateCharacters() {
      chars.forEach(char => {
        char.x += char.speedX * speedFactor;
        char.y += char.speedY * speedFactor;
        
        if (char.x <= 0 || char.x >= 100) {
          char.speedX *= -1;
          char.x = char.x <= 0 ? 0 : 100;
        }
        
        if (char.y <= 0 || char.y >= 100) {
          char.speedY *= -1;
          char.y = char.y <= 0 ? 0 : 100;
        }
        
        char.element.style.left = `${char.x}%`;
        char.element.style.top = `${char.y}%`;
        
        const sizeVariation = Math.sin(Date.now() * 0.002 + char.x) * 0.2;
        char.element.style.fontSize = `${char.size + sizeVariation}rem`;
        
        const opacity = 0.5 + Math.sin(Date.now() * 0.001 + char.y) * 0.3;
        char.element.style.opacity = Math.max(0.3, Math.min(0.9, opacity));
      });
      
      requestAnimationFrame(updateCharacters);
    }

    function updateCharCount() {
      document.getElementById('char-count').textContent = chars.length;
      document.getElementById('speed-value').textContent = speedFactor.toFixed(1);
    }

    // Chat functionality - Direct Gemini API integration
    async function sendMessage() {
      if (isProcessing) return;
      
      const input = document.getElementById('user-input');
      const message = input.value.trim();
      if (!message) return;

      isProcessing = true;
      const lang = translations[currentLang];

      const chatBox = document.getElementById('chat-box');
      
      // Add user message
      const userMessageDiv = document.createElement('div');
      userMessageDiv.className = 'message user-message';
      userMessageDiv.innerHTML = `${lang.userPrefix}: ${message}<div class="message-time">${lang.nowText}</div>`;
      chatBox.appendChild(userMessageDiv);
      
      input.value = '';

      // Add loading message
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message bot-message loading';
      loadingDiv.innerHTML = `${lang.botPrefix}: ${lang.thinking}<div class="message-time">${lang.nowText}</div>`;
      chatBox.appendChild(loadingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        // Prepare conversation history for context
        const conversationHistory = chatHistory[currentLang].slice(-4); // Keep last 2 exchanges
        
        // Build messages array with system instruction and conversation history
        const messages = [
          {
            role: "user",
            parts: [{ text: SYSTEM_INSTRUCTIONS[currentLang] }]
          },
          ...conversationHistory.flatMap(chat => [
            { role: "user", parts: [{ text: chat.user }] },
            { role: "model", parts: [{ text: chat.assistant }] }
          ]),
          {
            role: "user",
            parts: [{ text: message }]
          }
        ];

        // Call Gemini API directly
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: messages,
            generationConfig: {
              temperature: 0.7,
              topK: 40,
              topP: 0.95,
              maxOutputTokens: 1024,
            }
          })
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }

        const data = await response.json();
        
        // Remove loading message
        chatBox.removeChild(loadingDiv);
        
        // Extract response text
        let reply = '';
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
          reply = data.candidates[0].content.parts[0].text;
        } else {
          reply = lang.error;
        }
        
        // Add assistant response
        const botMessageDiv = document.createElement('div');
        botMessageDiv.className = 'message bot-message';
        botMessageDiv.innerHTML = `${lang.botPrefix}: ${reply}<div class="message-time">${lang.nowText}</div>`;
        chatBox.appendChild(botMessageDiv);
        
        // Update chat history
        chatHistory[currentLang].push({
          user: message,
          assistant: reply
        });
        
        // Keep only last 10 conversations to manage context length
        if (chatHistory[currentLang].length > 10) {
          chatHistory[currentLang] = chatHistory[currentLang].slice(-10);
        }
        
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // Speak the reply
        speakText(reply);
        
      } catch (error) {
        console.error('Error:', error);
        
        // Remove loading message
        if (loadingDiv.parentNode) {
          chatBox.removeChild(loadingDiv);
        }
        
        // Show error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message bot-message';
        errorDiv.innerHTML = `${lang.botPrefix}: ${lang.error}<div class="message-time">${lang.nowText}</div>`;
        chatBox.appendChild(errorDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      } finally {
        isProcessing = false;
      }
    }

    function speakText(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = currentLang === 'hi' ? 'hi-IN' : 'en-US';
        utterance.rate = 0.9;
        utterance.pitch = 1;
        window.speechSynthesis.speak(utterance);
      }
    }

    // Voice input
    function startVoice() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        const errorMsg = currentLang === 'hi' ? 
          "आपका ब्राउज़र वॉइस रिकॉग्निशन का समर्थन नहीं करता है。" : 
          "Your browser doesn't support voice recognition.";
        alert(errorMsg);
        return;
      }
      
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = currentLang === 'hi' ? 'hi-IN' : 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.start();

      recognition.onresult = function(event) {
        const text = event.results[0][0].transcript;
        document.getElementById('user-input').value = text;
        sendMessage();
      };

      recognition.onerror = function(e) {
        const errorMsg = currentLang === 'hi' ? 
          "माइक में समस्या आई है: " + e.error : 
          "Microphone error: " + e.error;
        console.error(errorMsg);
      };
    }

    // Event listeners
    document.getElementById('user-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Toggle switch event listener
    document.getElementById('lang-toggle').addEventListener('change', function() {
      switchLanguage();
    });

    // Initialize
    createCharacters(50);
    updateCharacters();
    updateInterfaceLanguage();

    // Handle window resize
    window.addEventListener('resize', () => {
      chars.forEach(char => {
        char.x = Math.min(100, Math.max(0, char.x));
        char.y = Math.min(100, Math.max(0, char.y));
      });
    });

    // Add color theme cycling
    setInterval(() => {
      colorTheme = (colorTheme + 1) % colorThemes.length;
      chars.forEach(char => applyColor(char.element));
    }, 30000);
  </script>
</body>
</html>